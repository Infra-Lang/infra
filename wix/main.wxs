<?xml version="1.0"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*"
           Name="Infra Programming Language"
           Language="1033"
           Version="$(var.Version)"
           Manufacturer="Infra-Lang"
           UpgradeCode="A4B2C3D1-E5F6-7890-ABCD-EF1234567890">

    <Package InstallerVersion="200"
             Compressed="yes"
             InstallScope="perMachine"
             Description="Infra Programming Language Installer"
             Comments="A simple, Python-like programming language built for performance and competitive programming" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of Infra is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Installation directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="Infra" />
      </Directory>

      <!-- Start Menu Programs directory -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Infra"/>
      </Directory>

      <!-- Desktop directory for optional shortcut -->
      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>

    <!-- Installation components -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="MainExecutable" Guid="*">
        <File Id="InfraExe"
              Source="$(var.TargetDir)infra.exe"
              KeyPath="yes" />

        <!-- Add to PATH environment variable -->
        <Environment Id="PATH"
                     Name="PATH"
                     Value="[INSTALLFOLDER]"
                     Permanent="no"
                     Part="last"
                     Action="set"
                     System="yes" />
      </Component>

      <Component Id="Documentation" Guid="*">
        <File Id="ReadmeFile"
              Source="$(var.ProjectDir)README.md" />
        <File Id="LicenseFile"
              Source="$(var.ProjectDir)LICENSE" />
      </Component>
    </DirectoryRef>

    <!-- Start Menu shortcuts -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcuts" Guid="*">
        <Shortcut Id="InfraStartMenuShortcut"
                  Name="Infra REPL"
                  Description="Infra Programming Language Interactive Shell"
                  Target="[#InfraExe]"
                  WorkingDirectory="INSTALLFOLDER"
                  Arguments="--repl"
                  Icon="InfraIcon.exe" />

        <Shortcut Id="UninstallShortcut"
                  Name="Uninstall Infra"
                  Description="Uninstall Infra Programming Language"
                  Target="[SystemFolder]msiexec.exe"
                  Arguments="/x [ProductCode]"
                  Icon="InfraIcon.exe" />

        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU"
                       Key="Software\Infra-Lang\Infra"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Desktop shortcut (optional) -->
    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="*">
        <Shortcut Id="InfraDesktopShortcut"
                  Name="Infra REPL"
                  Description="Infra Programming Language Interactive Shell"
                  Target="[#InfraExe]"
                  WorkingDirectory="INSTALLFOLDER"
                  Arguments="--repl"
                  Icon="InfraIcon.exe" />
        <RegistryValue Root="HKCU"
                       Key="Software\Infra-Lang\Infra"
                       Name="desktop_shortcut"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- File association for .if files -->
    <Component Id="FileAssociation" Guid="*">
      <RegistryKey Root="HKCR"
                   Key=".if"
                   Action="createAndRemoveOnUninstall">
        <RegistryValue Type="string" Value="Infra.File" />
        <RegistryValue Name="Content Type" Type="string" Value="text/plain" />
      </RegistryKey>

      <RegistryKey Root="HKCR"
                   Key="Infra.File"
                   Action="createAndRemoveOnUninstall">
        <RegistryValue Type="string" Value="Infra Source File" />
        <RegistryKey Key="DefaultIcon">
          <RegistryValue Type="string" Value="[#InfraExe],0" />
        </RegistryKey>
        <RegistryKey Key="shell\open\command">
          <RegistryValue Type="string" Value="&quot;[#InfraExe]&quot; &quot;%1&quot;" />
        </RegistryKey>
      </RegistryKey>
    </Component>

    <!-- Feature definitions -->
    <Feature Id="Complete"
             Title="Infra Programming Language"
             Description="The complete package."
             Display="expand"
             ConfigurableDirectory="INSTALLFOLDER">

      <Feature Id="MainProgram"
               Title="Infra Compiler and REPL"
               Description="Infra programming language interpreter and interactive shell."
               Level="1">
        <ComponentRef Id="MainExecutable" />
      </Feature>

      <Feature Id="Documentation"
               Title="Documentation"
               Description="README and license files."
               Level="1">
        <ComponentRef Id="Documentation" />
      </Feature>

      <Feature Id="Shortcuts"
               Title="Start Menu Shortcuts"
               Description="Start menu shortcuts for Infra."
               Level="1">
        <ComponentRef Id="ApplicationShortcuts" />
      </Feature>

      <Feature Id="DesktopShortcut"
               Title="Desktop Shortcut"
               Description="Desktop shortcut for Infra REPL."
               Level="1000">
        <ComponentRef Id="DesktopShortcut" />
      </Feature>

      <Feature Id="FileAssociation"
               Title="File Association"
               Description="Associate .if files with Infra."
               Level="1">
        <ComponentRef Id="FileAssociation" />
      </Feature>
    </Feature>

    <!-- UI configuration -->
    <UIRef Id="WixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <!-- License agreement (if you have one) -->
    <!-- <WixVariable Id="WixUILicenseRtf" Value="License.rtf" /> -->

    <!-- Icon definition -->
    <Icon Id="InfraIcon.exe" SourceFile="$(var.TargetDir)infra.exe" />

  </Product>
</Wix>
